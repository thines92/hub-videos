<!DOCTYPE html>
<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"
  ></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    #player-wrapper {
      width: 75%;
      margin-left: auto;
      margin-right: auto;
      max-width: 750px;
      margin-bottom: 30px;
    }
    #player {
      width: 100%;
    }
    #video-list {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      text-align: center;
    }
    #video-list .video {
      width: 50%;
      margin-right: auto;
      margin-left: auto;
      max-width: 350px;
      padding-bottom: 0;
      height: auto;
    }
    #video-list .video-img img {
      width: 85%;
      height: auto !important;
    }
  </style>
</head>
  <body>
    <!-- The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player-wrapper">
      <div id="player"></div>
    </div>

    <div id="filter">
      <p>Filter videos</p>
      <div class="filter-boxes">
        <input type="radio" id="plastic-filter" name="pen">Plastic Pens
        <input type="radio" id="metal-filter" name="pen">Metal Pens
      </div>
    </div>

    <div class="videos-wrapper">
      <h2 style="text-align: center">View our other videos!</h2>
      <div id="video-list">
        
      </div>
    </div>    

  <script type='text/template' class='template'>
    <div class="video" data-videoId="<%= item.contentDetails.videoId %>">
      <a href="#" class="video-img">
        <img src="<%= item.snippet.thumbnails.default.url %>">
      </a>
      <div class="video-title">
        <h4><%= item.snippet.title %></h4>
      </div>
    </div>
  </script>  

  <script>

    var videos = [];
    var videoIds = [];
    var tags = [];
    var filter = '';

    // This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // This function creates an <iframe> (and YouTube player)
    // after the API code downloads.
    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        host: 'http://www.youtube.com',
        height: '390',
        videoId: 'mxPIAABeccw'
      });
    }

    // Connecting to the HTML template.
    _.templateSettings.variable = 'item'; 
    var template = _.template(
      $('script.template').html()
    );
    
    // First Ajax call to get all videos in a playlist
    $.ajax({
      url: 'https://www.googleapis.com/youtube/v3/playlistItems?part=snippet%2CcontentDetails&playlistId=PLDMiO_JRdp9xJYFRGzIS5DQ91GCTvkJP0&key=AIzaSyBTT5MRYUUBRCeMq41ducP6qPhYy5kQ1Ag',
      data: {},
      success: function(data) {
        $.each(data.items, function(index, item) {
          videos.push(item);
          videoIds.push(item.contentDetails.videoId);
        })

      }
    }).done(function(data) {
        var videoId = videoIds.join('%');
        renderVideos(videos); 
        getVideoTags();
    })

    // Second Ajax call to get individual video's tags
    function getVideoTags() {
      $.ajax({
        url: 'https://www.googleapis.com/youtube/v3/videos?fields=items(snippet(tags))&part=snippet&id=' + videoIds + '&key=AIzaSyBTT5MRYUUBRCeMq41ducP6qPhYy5kQ1Ag',
        success: function(data) {
          _.each(data.items, function(val, i) {
            _.each(val.snippet, function(item, i) {
              tags.push(item);
            })
          })
        }
      }).done(function(data) {
        embedTags(videos, tags);
        console.log(videos);
      })
    }

    // Attaches the approriate tags to each video.
    function embedTags(videos, tags) {
      for(i = 0; i < videos.length; i++) {
        videos[i].tags = tags[i].join(', ');
      }
    }

    // Loads a video into the YouTube player.
    function loadVideo(videoId) {
      player.loadVideoById(videoId);
    }

    function setPlasticFilter() {
      filter = "Plastic";
      filterVideos();
    }

    function setMetalFilter() {
      filter = "Metal";
      filterVideos();
    }

    // Filters videos using YouTube video tags as filters.
    function filterVideos(arr) {
      _.each(videos, function(element, index) {
      if(element.tags.indexOf(filter) === -1) {
        $('[data-videoId="' + element.contentDetails.videoId + '"]').hide();
        console.log(element.tags);
      }
        console.log(element);
      }, videos)
    }

    // Prepends every video in an array.
    var renderVideos = function(arr) {
      _.each(arr, function(elem) {
        $('#video-list').prepend(template(elem));
      });
    };

    $('#video-list').on("click", '.video', function() {
      var videoId = this.dataset.videoid;
      loadVideo(videoId);
    })

    $('#plastic-filter').on("click", function() {
      setPlasticFilter();
    });

    $('#metal-filter').on("click", function() {
      setMetalFilter();
    });

  </script>
  </body>
</html>